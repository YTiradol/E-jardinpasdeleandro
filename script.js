document.addEventListener("DOMContentLoaded", () => {
    const joursSemaine = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];
    
    let aujourdHui = new Date();
    const calendarHeader = document.getElementById("calendar-header");
    const calendarBody = document.getElementById("calendar-body");

    for (let i = 0; i < 5; i++) {
        let jourSuivant = new Date();
        jourSuivant.setDate(aujourdHui.getDate() + i);

        let jourTexte = joursSemaine[jourSuivant.getDay()];
        let dateTexte = jourSuivant.getDate() + "/" + (jourSuivant.getMonth() + 1);

        let th = document.createElement("th");
        th.textContent = jourTexte + " (" + dateTexte + ")";
        calendarHeader.appendChild(th);

        let td = document.createElement("td");
        td.textContent = "?";
        td.setAttribute("data-jour", jourTexte);
        td.addEventListener("click", () => afficherConseil(jourTexte));
        calendarBody.appendChild(td);
    }

    function afficherConseil(jour) {
        const conseils = {
            "Lun": "Arrosez vos plantes le matin. üåû",
            "Mar": "V√©rifiez l'humidit√© du sol avant d'arroser. üíß",
            "Mer": "Taillez vos arbustes pour favoriser la croissance. ‚úÇÔ∏è",
            "Jeu": "Pensez √† d√©sherber votre jardin. üå±",
            "Ven": "Apportez un engrais naturel √† vos plantes. ü™¥",
            "Sam": "V√©rifiez la pr√©sence de parasites. üêõ",
            "Dim": "Profitez de votre jardin et relaxez-vous ! ‚òÄÔ∏è"
        };
        
        document.getElementById("conseil-texte").textContent = conseils[jour] || "Aucun conseil disponible.";
    }

    document.querySelectorAll(".nav-btn").forEach(button => {
        button.addEventListener("click", () => {
            const targetSection = button.getAttribute("data-target");
            document.querySelectorAll(".section").forEach(section => {
                section.classList.remove("active");
            });
            document.getElementById(targetSection).classList.add("active");
        });
    });

    const modal = document.getElementById("modal");
    const addPlantBtn = document.getElementById("add-plant-btn");
    const closeModal = document.querySelector(".close");
    const plantList = document.getElementById("plant-list");
    const plantInfoModal = document.getElementById("plant-info-modal");
    const plantInfoContent = document.getElementById("plant-info-content");
    const closePlantInfo = document.getElementById("close-plant-info");

    addPlantBtn.addEventListener("click", () => {
        modal.style.display = "flex";
    });

    closeModal.addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
        if (event.target === modal) {
            modal.style.display = "none";
        }
        if (event.target === plantInfoModal) {
            plantInfoModal.style.display = "none";
        }
    });

    document.querySelectorAll(".plant-item").forEach(item => {
        item.addEventListener("click", () => {
            const plantName = item.getAttribute("data-name");
            const plantImgSrc = item.querySelector("img").src;

            const listItem = document.createElement("li");
            listItem.setAttribute("data-name", plantName);
            listItem.setAttribute("data-description", ""); // Description vide pour que tu la remplisses plus tard
            
            const plantImg = document.createElement("img");
            plantImg.src = plantImgSrc;
            plantImg.width = 40;
            plantImg.style.borderRadius = "5px";
            
            listItem.appendChild(plantImg);
            listItem.appendChild(document.createTextNode(plantName));
            listItem.addEventListener("click", () => afficherInfoPlante(listItem));

            plantList.appendChild(listItem);
            modal.style.display = "none";
        });
    });

    function afficherInfoPlante(plantItem) {
        const plantName = plantItem.getAttribute("data-name");
        const plantDescription = plantItem.getAttribute("data-description");
        
        plantInfoContent.innerHTML = `<h2>${plantName}</h2><p>${plantDescription}</p>`;
        plantInfoModal.style.display = "flex";
    }

    closePlantInfo.addEventListener("click", () => {
        plantInfoModal.style.display = "none";
    });
});

document.addEventListener("DOMContentLoaded", () => {
    const plantInfoModal = document.getElementById("plant-info-modal");
    const plantInfoName = document.getElementById("plant-info-name");
    const plantInfoImage = document.getElementById("plant-info-image");
    const plantInfoDescription = document.getElementById("plant-info-description");
    const closeInfoModal = document.getElementById("close-info-modal");

    // Ajout d'un event listener pour chaque plante ajout√©e
    document.getElementById("plant-list").addEventListener("click", (event) => {
        if (event.target.tagName === "IMG") {
            const listItem = event.target.parentElement;
            const plantName = listItem.textContent.trim();
            const plantImgSrc = event.target.src;

            // Affichage des infos dans la modale
            plantInfoName.textContent = plantName;
            plantInfoImage.src = plantImgSrc;
            plantInfoDescription.textContent = "Info de la plante disponible quand l'equipe de developpement aura le budget d'acheter un broche arduino pour se connecter en bleuthoot"; // Laisse vide pour que tu puisses la remplir

            // Afficher la fen√™tre modale
            plantInfoModal.style.display = "flex";
        }
    });

    // Fermer la modale des infos
    closeInfoModal.addEventListener("click", () => {
        plantInfoModal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
        if (event.target === plantInfoModal) {
            plantInfoModal.style.display = "none";
        }
    });
});

let video, canvas, ctx, model;
let currentFacingMode = "environment"; 

document.getElementById("start-button").addEventListener("click", startCamera);
document.getElementById("analyze-button").addEventListener("click", startAnalysis);

async function startCamera() {
    document.getElementById("start-button").style.display = "none";
    document.getElementById("analyze-button").style.display = "block";

    video = document.getElementById("video");
    canvas = document.getElementById("ar-overlay");
    ctx = canvas.getContext("2d");

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480, facingMode: currentFacingMode }
        });
        video.srcObject = stream;
        model = await mobilenet.load();
    } catch (err) {
        console.error("Erreur d'acc√®s √† la cam√©ra:", err);
        alert("Impossible d'acc√©der √† la cam√©ra.");
    }
}

function switchCamera(facingMode) {
    currentFacingMode = facingMode;
    startCamera();
}

async function startAnalysis() {
    if (!video) {
        alert("Cam√©ra non active.");
        return;
    }

    captureAndSendImage();
}

function captureAndSendImage() {
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = video.videoWidth;
    tempCanvas.height = video.videoHeight;
    const tempCtx = tempCanvas.getContext("2d");
    tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);

    tempCanvas.toBlob(blob => {
        sendToPlantID(blob);
    }, "image/jpeg");
}

async function sendToPlantID(imageBlob) {
    const formData = new FormData();
    formData.append("images", imageBlob);

    try {
        const response = await fetch("https://api.plant.id/v3/identification", {
            method: "POST",
            headers: {
                "Api-Key": "7bgm7IMFOa3sQ0oyQhcELv3UcspSvyLAhe5l2jb4yLikzisn7O",
            },
            body: formData,
        });

        if (!response.ok) {
            throw new Error(`Erreur API: ${response.status} - ${response.statusText}`);
        }

        const data = await response.json();
        processPlantData(data);
    } catch (error) {
        console.error("Erreur API:", error);
        alert("Erreur avec Plant.id.");
    }
}

function processPlantData(data) {
    if (data.status === "COMPLETED") {
        const suggestion = data.result.classification.suggestions[0];
        let detectedPlantScientific = suggestion.name;
        let detectedPlantCommon = plantDatabase[detectedPlantScientific] || "Nom inconnu";
        let confidenceScore = (suggestion.probability * 100).toFixed(2) + "%";

        document.getElementById("plant-name").textContent = `${detectedPlantScientific} (${detectedPlantCommon}) - ${confidenceScore}`;
        document.getElementById("info-box").style.display = "block";
    }
}

// Base de donn√©es des plantes (extrait)
const plantDatabase = {
    "Aloe vera": "Aloe vera",
        "Mentha √ó piperita": "Menthe poivr√©e",
        "Rosmarinus officinalis": "Romarin",
        "Thymus vulgaris": "Thym",
        "Lavandula angustifolia": "Lavande vraie",
        "Matricaria chamomilla": "Camomille allemande",
        "Salvia officinalis": "Sauge officinale",
        "Echinacea purpurea": "√âchinac√©e pourpre",
        "Zingiber officinale": "Gingembre",
        "Curcuma longa": "Curcuma",
        "Melissa officinalis": "M√©lisse",
        "Artemisia absinthium": "Absinthe",
        "Foeniculum vulgare": "Fenouil",
        "Cinnamomum verum": "Cannelle",
        "Piper nigrum": "Poivre noir",
        "Valeriana officinalis": "Val√©riane",
        "Passiflora incarnata": "Passiflore",
        "Hypericum perforatum": "Millepertuis",
        "Achillea millefolium": "Achill√©e millefeuille",
        "Urtica dioica": "Ortie",

        // üå∫ Plantes Ornementales
        "Rosa spp.": "Rose",
        "Tulipa spp.": "Tulipe",
        "Narcissus spp.": "Narcisse",
        "Hibiscus rosa-sinensis": "Hibiscus",
        "Orchidaceae spp.": "Orchid√©e",
        "Petunia hybrida": "P√©tunia",
        "Begonia semperflorens": "B√©gonia",
        "Dahlia pinnata": "Dahlia",
        "Lilium spp.": "Lys",
        "Chrysanthemum spp.": "Chrysanth√®me",

        // üå≥ Arbres et Arbustes
        "Quercus robur": "Ch√™ne p√©doncul√©",
        "Fagus sylvatica": "H√™tre commun",
        "Acer saccharum": "√ârable √† sucre",
        "Betula pendula": "Bouleau verruqueux",
        "Olea europaea": "Olivier",
        "Prunus avium": "Merisier",
        "Magnolia grandiflora": "Magnolia",
        "Pinus sylvestris": "Pin sylvestre",
        "Ginkgo biloba": "Ginkgo",
        "Cedrus atlantica": "C√®dre de l‚ÄôAtlas",

        // üçä Plantes Fruiti√®res
        "Malus domestica": "Pommier",
        "Pyrus communis": "Poirier",
        "Citrus √ó sinensis": "Oranger doux",
        "Prunus persica": "P√™cher",
        "Vitis vinifera": "Vigne",
        "Fragaria √ó ananassa": "Fraisier",
        "Rubus idaeus": "Framboisier",
        "Vaccinium corymbosum": "Myrtillier",
        "Musa √ó paradisiaca": "Bananier",
        "Coffea arabica": "Caf√©ier",

        // üåæ C√©r√©ales et L√©gumineuses
        "Zea mays": "Ma√Øs",
        "Triticum aestivum": "Bl√© tendre",
        "Oryza sativa": "Riz",
        "Hordeum vulgare": "Orge",
        "Secale cereale": "Seigle",
        "Avena sativa": "Avoine",
        "Glycine max": "Soja",
        "Cicer arietinum": "Pois chiche",
        "Lens culinaris": "Lentille",
        "Phaseolus vulgaris": "Haricot commun",

        // üåø Plantes Sauvages et Utilitaires
        "Taraxacum officinale": "Pissenlit",
        "Plantago major": "Grand plantain",
        "Rumex acetosa": "Oseille",
        "Chenopodium album": "Ch√©nopode blanc",
        "Sambucus nigra": "Sureau noir",
        "Trifolium pratense": "Tr√®fle rouge",
        "Arctium lappa": "Bardane",
        "Equisetum arvense": "Pr√™le des champs",
        "Viola tricolor": "Pens√©e sauvage",
        "Bellis perennis": "P√¢querette",

        // üå± Plantes Aquatiques
        "Nymphaea alba": "N√©nuphar blanc",
        "Lemna minor": "Lentille d‚Äôeau",
        "Myriophyllum spicatum": "Myriophylle en √©pi",
        "Ceratophyllum demersum": "Cornifle immerg√©",
        "Sagittaria sagittifolia": "Fl√®che d‚Äôeau",
        "Typha latifolia": "Massette √† larges feuilles",
        "Nelumbo nucifera": "Lotus sacr√©",
        "Hydrilla verticillata": "Hydrilla",
        "Eichhornia crassipes": "Jacinthe d‚Äôeau",
        "Utricularia vulgaris": "Utriculaire commune",

        // üåø Plantes Tropicales et Exotiques
        "Theobroma cacao": "Cacaoyer",
        "Ananas comosus": "Ananas",
        "Carica papaya": "Papayer",
        "Persea americana": "Avocatier",
        "Cocos nucifera": "Cocotier",
        "Mangifera indica": "Manguier",
        "Psidium guajava": "Goyavier",
        "Litchi chinensis": "Litchi",
        "Passiflora edulis": "Fruit de la passion",
        "Dioscorea alata": "Igname",
        "Euterpe oleracea": "A√ßa√Ø",
        "Syzygium aromaticum": "Giroflier",
        "Annona muricata": "Corossolier",
        "Colocasia esculenta": "Taro",
        "Elettaria cardamomum": "Cardamome",
        "Bixa orellana": "Roucou",
        "Myrciaria dubia": "Camu-camu",
        "Blighia sapida": "Aki",
        "Artocarpus heterophyllus": "Jacquier",
        "Nephelium lappaceum": "Ramboutan"
    };

    function processPlantData(data) {
        if (!data.result || !data.result.classification || !data.result.classification.suggestions.length) {
            alert("Aucune plante identifi√©e.");
            return;
        }
    
        const suggestion = data.result.classification.suggestions[0];
        let detectedPlantScientific = suggestion.name;
        let detectedPlantCommon = plantDatabase[detectedPlantScientific] || "Nom inconnu";
        let confidenceScore = (suggestion.probability * 100).toFixed(2) + "%";
    
        document.getElementById("plant-name").textContent = `${detectedPlantScientific} (${detectedPlantCommon}) - ${confidenceScore}`;
        document.getElementById("info-box").style.display = "block";
    
        // Stocker les infos de la plante analys√©e
        window.lastDetectedPlant = {
            name: detectedPlantCommon,
            scientific: detectedPlantScientific,
            imageSrc: document.getElementById("ar-overlay").toDataURL("image/png")
        };
    
        // Afficher le bouton d'ajout
        document.getElementById("add-plant-from-ar").style.display = "block";
    }

    document.getElementById("add-plant-from-ar").addEventListener("click", () => {
        if (!window.lastDetectedPlant) {
            alert("Aucune plante √† ajouter !");
            return;
        }
    
        const { name, scientific, imageSrc } = window.lastDetectedPlant;
        const plantList = document.getElementById("plant-list");
    
        // Cr√©er l'√©l√©ment de liste
        const listItem = document.createElement("li");
        listItem.setAttribute("data-name", scientific);
        listItem.setAttribute("data-description", "Plante identifi√©e par analyse.");
    
        const plantImg = document.createElement("img");
        plantImg.src = imageSrc;
        plantImg.width = 40;
        plantImg.style.borderRadius = "5px";
    
        listItem.appendChild(plantImg);
        listItem.appendChild(document.createTextNode(` ${name} (${scientific})`));
    
        // Ajouter l'√©v√©nement pour afficher les infos
        listItem.addEventListener("click", () => afficherInfoPlante(listItem));
    
        plantList.appendChild(listItem);
    
        // Cacher le bouton apr√®s l'ajout
        document.getElementById("add-plant-from-ar").style.display = "none";
    
        // R√©initialiser les donn√©es stock√©es
        window.lastDetectedPlant = null;
    });
    
    document.getElementById("change-plant-image-btn").addEventListener("click", () => {
        document.getElementById("plant-image-input").click();
    });
    
    // Quand l'utilisateur s√©lectionne une nouvelle image
    document.getElementById("plant-image-input").addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const newImageSrc = e.target.result;
    
                // Mettre √† jour l'image dans la modale
                document.getElementById("plant-info-image").src = newImageSrc;
    
                // Trouver la plante dans la liste et mettre √† jour son image
                const plantName = document.getElementById("plant-info-name").textContent;
                document.querySelectorAll("#plant-list li").forEach(li => {
                    if (li.textContent.includes(plantName)) {
                        li.querySelector("img").src = newImageSrc;
                    }
                });
    
                // R√©initialiser l'input file pour pouvoir re-s√©lectionner une autre image apr√®s
                document.getElementById("plant-image-input").value = "";
            };
    
            reader.readAsDataURL(file);
        }
    });
